<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Serenity - Complete Affirmations & Wisdom</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
            user-select: none;
            -webkit-user-select: none;
        }
        
        html {
            height: 100%;
            -webkit-text-size-adjust: 100%;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #F5F8FA 0%, #E8F4F8 40%, #DFF3F7 70%, #F0F8FF 100%);
            height: 100vh;
            height: 100dvh;
            display: flex;
            flex-direction: column;
            margin: 0;
            padding: 0;
            line-height: 1.6;
            overflow: hidden;
            position: fixed;
            width: 100%;
            top: 0;
            left: 0;
            transition: background 1.5s ease-in-out;
        }
        
        /* Background variations */
        .bg-peaceful { background: linear-gradient(135deg, #F0F8F0 0%, #E8F5E8 40%, #DFF7DF 70%, #F8FFF8 100%); }
        .bg-calm { background: linear-gradient(135deg, #F8F5F8 0%, #F0E8F0 40%, #F2DFF2 70%, #FFF8FF 100%); }
        .bg-tranquil { background: linear-gradient(135deg, #F8F8F0 0%, #F5F5E8 40%, #F7F7DF 70%, #FFFFF8 100%); }
        .bg-gentle { background: linear-gradient(135deg, #F0F5F8 0%, #E8F0F5 40%, #DFF2F7 70%, #F8FDFF 100%); }
        
        .container {
            width: calc(100% - 32px);
            height: calc(100% - 32px);
            background: rgba(255, 255, 255, 0.65);
            backdrop-filter: blur(15px);
            -webkit-backdrop-filter: blur(15px);
            padding: env(safe-area-inset-top, 44px) 20px env(safe-area-inset-bottom, 34px) 20px;
            display: flex;
            flex-direction: column;
            position: relative;
            overflow: hidden;
            margin: 16px;
            border-radius: 24px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }
        
        .header {
            padding: 20px 0 30px 0;
            text-align: center;
            flex-shrink: 0;
            border-bottom: 1px solid rgba(74, 144, 184, 0.08);
            margin-bottom: 30px;
        }
        
        .logo {
            font-size: 2.8em;
            font-weight: 200;
            color: #2C5F7A;
            margin-bottom: 8px;
            letter-spacing: 1px;
        }
        
        .subtitle {
            color: #6B8FA3;
            font-size: 1em;
            font-weight: 400;
            opacity: 0.9;
        }
        
        .content-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
            padding: 40px 16px;
            text-align: center;
            position: relative;
            min-height: 0;
        }
        
        .content-type {
            font-size: 0.85em;
            text-transform: uppercase;
            letter-spacing: 4px;
            color: #4A90B8;
            margin-bottom: 20px;
            font-weight: 700;
            opacity: 0.9;
        }
        
        .category {
            font-size: 0.8em;
            color: #7FB069;
            font-weight: 600;
            margin-bottom: 24px;
            text-transform: uppercase;
            letter-spacing: 2px;
            opacity: 0.85;
            padding: 8px 16px;
            background: rgba(127, 176, 105, 0.1);
            border-radius: 20px;
            display: inline-block;
        }
        
        .affirmation {
            font-family: 'Georgia', 'Times New Roman', serif;
            font-size: 1.4em;
            font-weight: 400;
            color: #2C3E50;
            line-height: 1.8;
            margin-bottom: 30px;
            opacity: 1;
            transition: opacity 0.3s ease-in-out;
            text-align: center;
            max-height: 50vh;
            overflow-y: auto;
            padding: 0 8px;
            font-style: italic;
        }
        
        .affirmation::-webkit-scrollbar {
            display: none;
        }
        
        .affirmation.updating {
            opacity: 0;
        }
        
        .affirmation::-webkit-scrollbar {
            display: none;
        }
        
        .wisdom {
            font-size: 1.1em;
            font-weight: 500;
            color: #6B8FA3;
            line-height: 1.6;
            margin-top: 30px;
            padding: 20px;
            background: rgba(107, 143, 163, 0.08);
            border-radius: 16px;
            border-left: 4px solid #6B8FA3;
            font-style: italic;
            opacity: 0;
            transform: translateY(15px);
            animation: fadeInUp 0.7s ease forwards;
        }
        
        .bottom-area {
            flex-shrink: 0;
            padding: 20px 0;
            text-align: center;
        }
        
        .swipe-hint {
            font-size: 0.85em;
            color: #6B8FA3;
            opacity: 0.7;
            padding: 12px 20px;
            background: rgba(107, 143, 163, 0.08);
            border-radius: 25px;
            display: inline-block;
            animation: pulseGlow 3s infinite;
            border: 1px solid rgba(107, 143, 163, 0.15);
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .swipe-hint:hover {
            opacity: 1;
            transform: scale(1.02);
            background: rgba(107, 143, 163, 0.12);
        }
        
        /* Settings Panel */
        .settings-panel {
            position: fixed;
            top: 0;
            right: -320px;
            width: 320px;
            height: 100vh;
            height: 100dvh;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            padding: 80px 20px 60px 20px;
            transition: right 0.3s ease;
            box-shadow: -5px 0 20px rgba(0, 0, 0, 0.1);
            z-index: 1000;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
            overscroll-behavior: contain;
            overflow-x: hidden;
        }
        
        .settings-panel.open {
            right: 0;
        }
        
        .settings-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.3);
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
            z-index: 999;
        }
        
        .settings-overlay.open {
            opacity: 1;
            visibility: visible;
        }
        
        .settings-btn {
            position: fixed;
            top: calc(env(safe-area-inset-top, 44px) + 20px);
            right: 20px;
            z-index: 1001;
            background: rgba(255, 255, 255, 0.8);
            border: none;
            border-radius: 50%;
            width: 44px;
            height: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            backdrop-filter: blur(10px);
            transition: all 0.2s ease;
        }
        
        .settings-btn:hover {
            background: rgba(255, 255, 255, 0.9);
            transform: scale(1.05);
        }
        
        .settings-section {
            margin-bottom: 30px;
        }
        
        .settings-title {
            font-size: 1.1em;
            font-weight: 600;
            color: #2C5F7A;
            margin-bottom: 15px;
        }
        
        .setting-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid rgba(74, 144, 184, 0.1);
        }
        
        .setting-label {
            font-size: 0.95em;
            color: #4A90B8;
        }
        
        .toggle-switch {
            position: relative;
            width: 50px;
            height: 24px;
            background: #ddd;
            border-radius: 12px;
            cursor: pointer;
            transition: background 0.3s ease;
        }
        
        .toggle-switch.active {
            background: #7FB069;
        }
        
        .toggle-switch::after {
            content: '';
            position: absolute;
            top: 2px;
            left: 2px;
            width: 20px;
            height: 20px;
            background: white;
            border-radius: 50%;
            transition: transform 0.3s ease;
        }
        
        .toggle-switch.active::after {
            transform: translateX(26px);
        }
        
        .slider {
            width: 100%;
            height: 6px;
            border-radius: 3px;
            background: #ddd;
            outline: none;
            -webkit-appearance: none;
            appearance: none;
        }
        
        .slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: #7FB069;
            cursor: pointer;
        }
        
        .category-filter {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 10px;
        }
        
        .category-tag {
            padding: 6px 12px;
            background: rgba(127, 176, 105, 0.1);
            border: 1px solid rgba(127, 176, 105, 0.3);
            border-radius: 16px;
            font-size: 0.8em;
            cursor: pointer;
            transition: all 0.2s ease;
            color: #7FB069;
        }
        
        .category-tag.active {
            background: #7FB069;
            color: white;
        }
        
        .favorite-btn, .reflect-btn {
            position: absolute;
            top: 20px;
            background: none;
            border: none;
            font-size: 1.5em;
            cursor: pointer;
            opacity: 0.6;
            transition: all 0.2s ease;
            z-index: 10;
        }
        
        .favorite-btn {
            right: 20px;
        }
        
        .reflect-btn {
            right: 70px;
            font-size: 1.3em;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.15);
        }
        
        .favorite-btn:hover, .reflect-btn:hover,
        .favorite-btn.favorited {
            opacity: 1;
            transform: scale(1.1);
        }
        
        .favorite-btn.favorited {
            color: #e74c3c;
        }
        
        .add-personal-btn, .view-reflections-btn {
            width: 100%;
            padding: 12px;
            margin: 8px 0;
            background: rgba(127, 176, 105, 0.1);
            border: 1px solid rgba(127, 176, 105, 0.3);
            border-radius: 8px;
            color: #7FB069;
            font-family: inherit;
            font-size: 0.9em;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .add-personal-btn:hover, .view-reflections-btn:hover {
            background: rgba(127, 176, 105, 0.2);
        }
        
        /* Modal Styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
            z-index: 2000;
        }
        
        .modal-overlay.open {
            opacity: 1;
            visibility: visible;
        }
        
        .modal {
            background: white;
            border-radius: 16px;
            padding: 30px;
            width: 90%;
            max-width: 400px;
            max-height: 80vh;
            overflow-y: auto;
        }
        
        .reflections-modal {
            max-width: 500px;
        }
        
        .modal h3 {
            color: #2C5F7A;
            margin-bottom: 20px;
            font-size: 1.2em;
        }
        
        .modal textarea, .modal select {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-family: inherit;
            font-size: 1em;
            margin-bottom: 15px;
        }
        
        .modal textarea {
            min-height: 100px;
            resize: vertical;
        }
        
        .modal-buttons {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }
        
        .modal button {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-family: inherit;
            font-size: 1em;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .modal button:first-child {
            background: #7FB069;
            color: white;
        }
        
        .modal button:first-child:hover {
            background: #6a9555;
        }
        
        .modal button:last-child {
            background: #ddd;
            color: #666;
        }
        
        .modal button:last-child:hover {
            background: #ccc;
        }
        
        .reflection-item {
            border-bottom: 1px solid rgba(74, 144, 184, 0.1);
            padding: 15px 0;
        }
        
        .reflection-date {
            font-size: 0.8em;
            color: #6B8FA3;
            margin-bottom: 5px;
        }
        
        .reflection-affirmation {
            font-style: italic;
            color: #4A90B8;
            margin-bottom: 8px;
            font-size: 0.9em;
        }
        
        .reflection-note {
            color: #2C3E50;
        }
        
        /* Night Mode */
        body.night-mode {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 40%, #0f3460 70%, #1a1a2e 100%);
        }
        
        .night-mode .container {
            background: rgba(30, 30, 50, 0.7);
        }
        
        .night-mode .logo {
            color: #a8c8ec;
        }
        
        .night-mode .subtitle {
            color: #7a9cc6;
        }
        
        .night-mode .content-type {
            color: #6bb6ff;
        }
        
        .night-mode .category {
            color: #9ed686;
            background: rgba(158, 214, 134, 0.15);
        }
        
        .night-mode .affirmation {
            color: #e8e8f0;
            font-family: 'Georgia', 'Times New Roman', serif;
        }
        
        .night-mode .wisdom {
            color: #a8c8ec;
            background: rgba(168, 200, 236, 0.1);
            border-left-color: #a8c8ec;
        }
        
        .night-mode .swipe-hint {
            color: #7a9cc6;
            background: rgba(122, 156, 198, 0.1);
            border-color: rgba(122, 156, 198, 0.2);
        }
        
        .night-mode .swipe-hint:hover {
            background: rgba(122, 156, 198, 0.15);
        }
        
        .night-mode .settings-panel {
            background: rgba(30, 30, 50, 0.95);
        }
        
        .night-mode .settings-btn {
            background: rgba(30, 30, 50, 0.8);
            color: #a8c8ec;
        }
        
        .night-mode .settings-title {
            color: #a8c8ec;
        }
        
        .night-mode .setting-label {
            color: #7a9cc6;
        }
        
        .night-mode .modal {
            background: rgba(30, 30, 50, 0.95);
            color: #e8e8f0;
        }
        
        .night-mode .modal h3 {
            color: #a8c8ec;
        }
        
        .night-mode .modal textarea, .night-mode .modal select {
            background: rgba(30, 30, 50, 0.8);
            border-color: #4a5568;
            color: #e8e8f0;
        }
        
        .night-mode .reflection-date {
            color: #7a9cc6;
        }
        
        .night-mode .reflection-affirmation {
            color: #6bb6ff;
        }
        
        .night-mode .reflection-note {
            color: #e8e8f0;
        }
        
        @keyframes pulseGlow {
            0%, 100% { opacity: 0.7; transform: scale(1); }
            50% { opacity: 0.9; transform: scale(1.02); }
        }
        
        @keyframes fadeInUp {
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .content-area.updating {
            transform: scale(0.98);
            transition: transform 0.3s ease;
        }
        
        .floating-elements {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            overflow: hidden;
        }
        
        .floating-element {
            position: absolute;
            width: 3px;
            height: 3px;
            background: radial-gradient(circle, rgba(74, 144, 184, 0.3), transparent);
            border-radius: 50%;
            animation: float 30s infinite linear;
        }
        
        @keyframes float {
            0% { transform: translateY(110vh) rotate(0deg); opacity: 0; }
            5% { opacity: 0.4; }
            95% { opacity: 0.4; }
            100% { transform: translateY(-20px) rotate(360deg); opacity: 0; }
        }
        

        
        /* Mobile responsive */
        @media (max-width: 430px) {
            .logo { font-size: 2.4em; }
            .affirmation { font-size: 1.3em; line-height: 1.7; }
            .content-area { padding: 30px 12px; }
            .container { margin: 12px; }
        }
        
        @media (max-width: 375px) {
            .logo { font-size: 2.2em; }
            .affirmation { font-size: 1.25em; }
            .header { padding: 15px 0 25px 0; margin-bottom: 25px; }
            .container { margin: 8px; }
        }
        
        /* Tablet responsive (iPad) */
        @media (min-width: 768px) and (max-width: 1024px) {
            .container {
                max-width: 600px;
                margin: 20px auto;
                border-radius: 32px;
                box-shadow: 0 12px 40px rgba(0, 0, 0, 0.15);
                width: calc(100% - 40px);
                height: calc(100% - 40px);
            }
            
            .logo { 
                font-size: 3.2em; 
                margin-bottom: 12px;
            }
            
            .subtitle { 
                font-size: 1.2em; 
            }
            
            .affirmation { 
                font-size: 1.6em; 
                line-height: 1.9;
                padding: 0 20px;
            }
            
            .content-area { 
                padding: 50px 30px; 
            }
            
            .wisdom {
                font-size: 1.3em;
                padding: 25px;
            }
            
            .category {
                font-size: 0.9em;
                padding: 10px 20px;
            }
            
            .content-type {
                font-size: 0.95em;
                letter-spacing: 6px;
            }
            
            .settings-panel {
                width: 380px;
                right: -380px;
                padding: 100px 30px 80px 30px;
            }
            
            .favorite-btn, .reflect-btn {
                font-size: 1.8em;
            }
            
            .favorite-btn { right: 30px; top: 30px; }
            .reflect-btn { right: 85px; top: 30px; }
            
            .swipe-hint {
                font-size: 1em;
                padding: 15px 25px;
            }
        }
        
        /* Desktop responsive */
        @media (min-width: 1025px) {
            .container {
                max-width: 800px;
                margin: 30px auto;
                border-radius: 40px;
                box-shadow: 0 20px 60px rgba(0, 0, 0, 0.2);
                width: calc(100% - 60px);
                height: calc(100% - 60px);
            }
            
            .logo { 
                font-size: 3.8em; 
                margin-bottom: 15px;
            }
            
            .subtitle { 
                font-size: 1.4em; 
            }
            
            .affirmation { 
                font-size: 1.8em; 
                line-height: 2.0;
                padding: 0 40px;
                max-width: 700px;
                margin: 0 auto 30px;
            }
            
            .content-area { 
                padding: 60px 50px; 
            }
            
            .wisdom {
                font-size: 1.4em;
                padding: 30px;
                max-width: 650px;
                margin: 30px auto 0;
            }
            
            .category {
                font-size: 1em;
                padding: 12px 24px;
            }
            
            .content-type {
                font-size: 1em;
                letter-spacing: 8px;
            }
            
            .settings-panel {
                width: 420px;
                right: -420px;
                padding: 120px 40px 100px 40px;
            }
            
            .favorite-btn, .reflect-btn {
                font-size: 2em;
            }
            
            .favorite-btn { right: 40px; top: 40px; }
            .reflect-btn { right: 100px; top: 40px; }
            
            .swipe-hint {
                font-size: 1.1em;
                padding: 18px 30px;
            }
            
            .modal {
                max-width: 500px;
                padding: 40px;
            }
            
            .modal h3 {
                font-size: 1.4em;
                margin-bottom: 25px;
            }
            
            .modal textarea {
                min-height: 120px;
                font-size: 1.1em;
                padding: 15px;
            }
        }
        
        /* Large desktop */
        @media (min-width: 1440px) {
            .container {
                max-width: 900px;
            }
            
            .affirmation {
                font-size: 2em;
                max-width: 800px;
            }
            
            .wisdom {
                max-width: 750px;
                font-size: 1.5em;
            }
        }
        
        @media (prefers-reduced-motion: reduce) {
            *, *::before, *::after {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
            }
        }
        
        /* iOS specific optimizations */
        @supports (-webkit-touch-callout: none) {
            body {
                -webkit-overflow-scrolling: touch;
                -webkit-user-select: none;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Settings Button -->
        <button class="settings-btn" id="settingsBtn">⚙️</button>
        
        <!-- Settings Overlay -->
        <div class="settings-overlay" id="settingsOverlay"></div>
        
        <!-- Settings Panel -->
        <div class="settings-panel" id="settingsPanel">
            <div class="settings-section">
                <h3 class="settings-title">Appearance</h3>
                <div class="setting-item">
                    <span class="setting-label">Night Mode</span>
                    <div class="toggle-switch" id="nightModeToggle"></div>
                </div>
                <div class="setting-item">
                    <span class="setting-label">Audio</span>
                    <div class="toggle-switch" id="audioToggle"></div>
                </div>
            </div>
            
            <div class="settings-section">
                <h3 class="settings-title">Categories</h3>
                <div class="category-filter" id="categoryFilter">
                    <div class="category-tag active" data-category="all">All</div>
                </div>
            </div>
            
            <div class="settings-section">
                <h3 class="settings-title">Personal</h3>
                <div class="setting-item">
                    <span class="setting-label">Show only favorites</span>
                    <div class="toggle-switch" id="favoritesOnlyToggle"></div>
                </div>
                <button class="add-personal-btn" id="addPersonalBtn">✨ Add Personal Affirmation</button>
                <button class="view-reflections-btn" id="viewReflectionsBtn">📝 View Reflections</button>
            </div>
        </div>
        
        <!-- Add Personal Modal -->
        <div class="modal-overlay" id="addPersonalOverlay">
            <div class="modal">
                <h3>Add Personal Affirmation</h3>
                <textarea id="personalText" placeholder="Enter your personal affirmation..." maxlength="500"></textarea>
                <select id="personalCategory">
                    <option value="Personal">Personal</option>
                    <option value="Abundance & Prosperity">Abundance & Prosperity</option>
                    <option value="Love & Relationships">Love & Relationships</option>
                    <option value="Success & Achievement">Success & Achievement</option>
                    <option value="Peace & Inner Harmony">Peace & Inner Harmony</option>
                    <option value="Divine Guidance & Protection">Divine Guidance & Protection</option>
                    <option value="Health & Healing">Health & Healing</option>
                    <option value="Transformation & Release">Transformation & Release</option>
                    <option value="Faith & Trust">Faith & Trust</option>
                </select>
                <div class="modal-buttons">
                    <button id="savePersonalBtn">Save</button>
                    <button id="cancelPersonalBtn">Cancel</button>
                </div>
            </div>
        </div>
        
        <!-- Reflections Modal -->
        <div class="modal-overlay" id="reflectionsOverlay">
            <div class="modal reflections-modal">
                <h3>My Reflections</h3>
                <div id="reflectionsList"></div>
                <button id="closeReflectionsBtn">Close</button>
            </div>
        </div>
        
        <!-- Reflection Input Modal -->
        <div class="modal-overlay" id="reflectionInputOverlay">
            <div class="modal">
                <h3>Reflect on this affirmation</h3>
                <p id="reflectionAffirmationText"></p>
                <textarea id="reflectionText" placeholder="How does this speak to you today?" maxlength="300"></textarea>
                <div class="modal-buttons">
                    <button id="saveReflectionBtn">Save Reflection</button>
                    <button id="skipReflectionBtn">Skip</button>
                </div>
            </div>
        </div>
        
        <div class="floating-elements">
            <div class="floating-element" style="left: 10%; animation-delay: 0s;"></div>
            <div class="floating-element" style="left: 30%; animation-delay: 8s;"></div>
            <div class="floating-element" style="left: 50%; animation-delay: 16s;"></div>
            <div class="floating-element" style="left: 70%; animation-delay: 6s;"></div>
            <div class="floating-element" style="left: 90%; animation-delay: 14s;"></div>
        </div>
        
        <div class="header">
            <h1 class="logo">Serenity</h1>
            <p class="subtitle">Affirmations & Wisdom Quotes</p>
        </div>
        
        <div class="content-area" id="contentArea">
            <button class="favorite-btn" id="favoriteBtn">♡</button>
            <button class="reflect-btn" id="reflectBtn">💭</button>
            
            <div class="content-type">AFFIRMATION</div>
            <div class="category" id="category">Abundance & Prosperity</div>
            <div class="affirmation" id="content">Infinite spirit, open the way for great abundance, for I am an irresistible magnet for all that belongs to me by divine right.</div>
            <div class="wisdom" id="wisdomContent">Faith without nerve is dead.</div>
        </div>
        
        <div class="bottom-area">
            <div class="swipe-hint" id="nextBtn">Next affirmation</div>
        </div>
    </div>

    <script>
        const affirmations = [
            { category: "Abundance & Prosperity", text: "Infinite spirit, open the way for great abundance, for I am an irresistible magnet for all that belongs to me by divine right." },
            { category: "Peace & Inner Harmony", text: "None of these things move me." },
            { category: "Success & Achievement", text: "I have a wonderful work in a wonderful way. I give wonderful service for wonderful pay." },
            { category: "Love & Relationships", text: "Every man is a golden link in the chain of my good." },
            { category: "Faith & Trust", text: "The unexpected happens, my seemingly impossible good now comes to pass." },
            { category: "Divine Guidance & Protection", text: "I am always under direct inspiration. I make right decisions quickly." },
            { category: "Health & Healing", text: "Divine love floods my consciousness with health, and every cell in my body is filled with light." },
            { category: "Transformation & Release", text: "I cast this burden on the Christ within, and I go free." },
            { category: "Abundance & Prosperity", text: "God is my unfailing supply, and large sums of money come to me quickly under grace in perfect ways." },
            { category: "Peace & Inner Harmony", text: "Great peace have they that love thy law and nothing shall offend them." },
            { category: "Success & Achievement", text: "I am fully equipped for the divine plan of my life and be fearless in grasping opportunities." },
            { category: "Faith & Trust", text: "As I am one with God, I am one with my good, for God is both the giver and the gift." },
            { category: "Love & Relationships", text: "I salute the divinity in you, I see your divine self only. I see you as God sees you, perfect, made in His image and likeness." },
            { category: "Divine Guidance & Protection", text: "Divine order is established in my mind, body, and affairs." },
            { category: "Health & Healing", text: "My eyes are God's eyes. I see with the eyes of spirit. I see clearly the open way." },
            { category: "Transformation & Release", text: "All bondage is an illusion of the race consciousness. There is always a way out of every situation, under grace." },
            { category: "Abundance & Prosperity", text: "Infinite spirit open the way for the right apartment." },
            { category: "Success & Achievement", text: "Holding to the vision and giving thanks that the end is accomplished and that I have already received." },
            { category: "Love & Relationships", text: "I am identified in love with the spirit of everyone connected with this institution. Let the divine idea come out of this situation." },
            { category: "Peace & Inner Harmony", text: "There are not two powers. There is only one power, God. Therefore, there are not disappointments, and this thing means a happy surprise." },
            { category: "Transformation & Release", text: "I baptize this failure success in the name of the Father and of the Son and of the Holy Ghost." },
            { category: "Love & Relationships", text: "As there was only one power, God, this person/situation is here for my good and my prosperity." },
            { category: "Divine Guidance & Protection", text: "Divine ideas never conflict; the call will come at the right time." },
            { category: "Divine Guidance & Protection", text: "I cannot lose any call that belongs to me by divine right. I'm under grace and not under law." },
            { category: "Peace & Inner Harmony", text: "I agree with my adversary quickly that the adverse situation is good." },
            { category: "Peace & Inner Harmony", text: "Live fully in the now." },
            { category: "Faith & Trust", text: "Thy will be done this day. Today is a day of completion. I give thanks for this perfect day. Miracles shall follow miracle, and wonder shall never cease." },
            { category: "Peace & Inner Harmony", text: "I look with wonder at that which is before me." },
            { category: "Divine Guidance & Protection", text: "Infinite intelligence, give me the right one, equally as charming as this, the one which is mine by divine right." },
            { category: "Faith & Trust", text: "I put the situation in the hands of infinite love and wisdom. If this is the Divine Plan, I bless it and no longer resist. But if it is not divinely planned, I give thanks that it is now dissolved and dissipated." },
            { category: "Transformation & Release", text: "Infinite spirit, I call on the law of forgiveness and give thanks that I am under grace and not under law and cannot lose this which is mine by divine right." },
            { category: "Transformation & Release", text: "I cast this burden on the Christ within, and I go free to have plenty to be loving, harmonious, and happy." },
            { category: "Love & Relationships", text: "There is no separation in divine mind; therefore, I cannot be separated from the love and companionship which are mine by divine right." },
            { category: "Divine Guidance & Protection", text: "Man is a perfect idea in divine mind and is always in his right place. Therefore, my I am is in my right place and I am divinely protected." },
            { category: "Divine Guidance & Protection", text: "Infinite Spirit, reveal to me the way. Let me know if there's anything for me to do." },
            { category: "Abundance & Prosperity", text: "Infinite spirit, open the way for my immediate supply, that all that is mine by divine right now reach me in great avalanches of abundance. Give me a definite lead, let me know if there's anything for me to do." },
            { category: "Faith & Trust", text: "Every false prophecy shall come to naught. Every plan my father in heaven has not planned shall be dissolved and dissipated. The divine idea now comes to pass." },
            { category: "Faith & Trust", text: "I will that the will of God be done." },
            { category: "Divine Guidance & Protection", text: "I deny loss. There is no loss in divine mind; therefore, I cannot lose that which belongs to me by divine right." },
            { category: "Abundance & Prosperity", text: "As the rent has been raised, it means that I'll be that much richer, for God is my supply." },
            { category: "Success & Achievement", text: "Infinite spirit, open the way for the divine design of my life to manifest, that the genius within me now be released. Let me see clearly the perfect plan." },
            { category: "Success & Achievement", text: "I am one with infinite intelligence. I know everything I should know on this subject." },
            { category: "Faith & Trust", text: "Declaring that I have already received before asking." },
            { category: "Abundance & Prosperity", text: "Infinite spirit, I give thanks that the one hundred million dollars which is mine by divine right is now released and reaches me under grace in a perfect way." },
            { category: "Faith & Trust", text: "Every plan my father in heaven has not planned shall be dissolved and dissipated and the divine idea now comes to pass." },
            { category: "Health & Healing", text: "Divine love now dissolves and dissipates every wrong condition in my mind, body, and affairs. Divine love is the most powerful chemical in the universe and dissolves everything which is not of itself." },
            { category: "Divine Guidance & Protection", text: "I am divinely sensitive to my intuitive leads and give instant obedience to thy will." },
            { category: "Health & Healing", text: "My ears are God's ears. I hear with the ears of spirit. I'm non-resistant and I'm willing to be led. I hear glad tidings of great joy." },
            { category: "Success & Achievement", text: "I have a perfect work in a perfect way. I give a perfect service for perfect pay." },
            { category: "Success & Achievement", text: "Let me now express the divine idea in my mind body and affairs." },
            { category: "Success & Achievement", text: "I am strong in the lord and the power of his might. I am backed by unnumbered hosts of power." },
            { category: "Transformation & Release", text: "Evil is unreal and leaves no stain." },
            { category: "Divine Guidance & Protection", text: "There is no loss in divine mind therefore I cannot lose this it will be restored to me or its equivalent." },
            { category: "Faith & Trust", text: "I only desire that which infinite intelligence desires through me. I claim that which is mine by divine right and under grace is a perfect way." },
            { category: "Success & Achievement", text: "My right work my perfect self-expression." },
            { category: "Success & Achievement", text: "Whereas i was blind now i can see clearly and distinctly the divine plan of my life." },
            { category: "Faith & Trust", text: "Whereas i was blind now i can see that god's power is the only power and that god's plan is the only plan." },
            { category: "Divine Guidance & Protection", text: "God is my eternal security of mind body and affairs." },
            { category: "Peace & Inner Harmony", text: "Let not your heart be troubled neither be afraid." },
            { category: "Love & Relationships", text: "My goodwill is a strong tower round about me. I now transmute all enemies into friends all in harmony into harmony all injustice into justice." },
            { category: "Abundance & Prosperity", text: "The walls of lack and delay now crumble away and I enter my promised land under grace." },
            { category: "Abundance & Prosperity", text: "Peace be within my walls and prosperity within my palaces." },
            { category: "Transformation & Release", text: "I will restore you to the years the locusts have eaten." },
            { category: "Abundance & Prosperity", text: "Whatever I desire or require is already on my pathway before ye call i have answered." },
            { category: "Success & Achievement", text: "I ride the waves into my promised land." },
            { category: "Health & Healing", text: "Whereas i was blind now i can see." },
            { category: "Peace & Inner Harmony", text: "In nothing be anxious but in everything be prayer and thanksgiving let your requests be made known unto God." },
            { category: "Abundance & Prosperity", text: "My supply comes from God and it has never failed." },
            { category: "Transformation & Release", text: "Behold I make all things new." },
            { category: "Faith & Trust", text: "The divine plan of my life is a perfect idea in divine mind incorruptible and indestructible and cannot be spoiled in any way." },
            { category: "Faith & Trust", text: "My prayers are answered/demonstrations come to pass." },
            { category: "Faith & Trust", text: "I am now back in the world of the wondrous where anything can happen overnight for when miracles do come they come quickly and I invite them in my life." },
            { category: "Faith & Trust", text: "God's ways are ingenious his methods are sure." },
            { category: "Success & Achievement", text: "What God has done for others he now does for me and more." },
            { category: "Peace & Inner Harmony", text: "Silence is golden." },
            { category: "Faith & Trust", text: "The unexpected happens my seemingly impossible good now comes to pass." },
            { category: "Abundance & Prosperity", text: "Feel rich and successful and suddenly you receive a large check or beautiful gift." },
            { category: "Faith & Trust", text: "My lamps are now filled with the oil of faith and fulfillment." },
            { category: "Abundance & Prosperity", text: "I call on the law of accumulation my supply comes from God and now pours in and piles up under grace in perfect ways." }
        ];

        const wisdomQuotes = [
            "Faith without nerve is dead.",
            "Never argue with a hunch.",
            "It's a great life if you don't reason.",
            "Power moves but is never moved.",
            "Divine ideas never conflict.",
            "Sure-ism is stronger than Optimism.",
            "Christopher Columbus followed a hunch.",
            "When in doubt play trumps, do the fearless thing.",
            "Before you call you are answered, for the supply precedes the demand.",
            "Fear and impatience demagnetize. Poise magnetizes.",
            "Intuition is a spiritual faculty and does not explain, but simply points the way.",
            "A man can receive nothing unless it is given to him from heaven.",
            "Every great work, every big accomplishment, has been brought into manifestation through holding to the vision.",
            "The game of life is a game of boomerangs. Our thoughts, deeds and words return to us sooner or later with astounding accuracy.",
            "No man is your enemy, no man is your friend, every man is your teacher.",
            "What man condemns in others, he attracts to himself.",
            "The subconscious mind has no sense of humor and people often joke themselves into unhappy experiences.",
            "You will be a failure, until you impress the subconscious with the conviction you are a success.",
            "The Chinese say that water wears away the hardest stone, and patience and persistence will overcome the greatest difficulties.",
            "Asking nothing, receiving everything.",
            "God does not know failure.",
            "Infinite Spirit, open the way for the Divine Design of my life to manifest; let the genius within me now be released; let me see clearly the perfect plan.",
            "The imaging faculty is the creative faculty.",
            "Words and thoughts are a tremendous vibratory force, ever moulding man's body and affairs.",
            "Man's word is his wand filled with magic and power!",
            "Jesus Christ said 'And ye shall know the truth and the truth shall make you free.'",
            "So man must be careful to decree that only the Divine Idea be made manifest, for often, he decrees, through his imaging faculty, his own limitation.",
            "Continually 'making-believe' impresses the subconscious mind with the conviction that the thing desired is already accomplished.",
            "Acting 'as if' were a magic wand which dissolves failure and brings success.",
            "The subconscious mind is the faithful servant but a poor master.",
            "Many a man is building a cage with his own thoughts.",
            "Change your expectancies and you change your conditions.",
            "Bless your enemy, and you rob him of his ammunition.",
            "The Christ within is man's own fourth dimensional self.",
            "Jesus Christ taught that it was done unto man, as he believed.",
            "Man can only receive what he sees himself receiving.",
            "The imaging faculty is man's own way to the Truth.",
            "Resentment, condemnation and hate, are the causes of disease and disaster.",
            "Love and good-will are invaluable in business. For example: A woman came to me, complaining that she was about to lose her position.",
            "There is always plenty on man's pathway, but it can only be brought into manifestation through desire, faith or the spoken word."
        ];

        const backgrounds = ['bg-peaceful', 'bg-calm', 'bg-tranquil', 'bg-gentle'];
        
        let wisdomIndex = 0;
        let bgIndex = 0;
        let currentAffirmation = null;
        let filteredAffirmations = affirmations;
        let personalAffirmations = [];
        let readingHistory = [];
        let autoAdvanceTimer = null;
        
        let settings = {
            nightMode: false,
            audioEnabled: false,
            selectedCategory: 'all',
            favoritesOnly: false
        };
        
        function changeBackground() {
            console.log('changeBackground called, bgIndex =', bgIndex, 'nightMode =', settings.nightMode);
            // Day mode now uses inline styles to override the default set by resetToDefaultBackground
            const dayBackgrounds = [
                'linear-gradient(135deg, #F0F8F0 0%, #E8F5E8 40%, #DFF7DF 70%, #F8FFF8 100%)', // bg-peaceful
                'linear-gradient(135deg, #F8F5F8 0%, #F0E8F0 40%, #F2DFF2 70%, #FFF8FF 100%)', // bg-calm  
                'linear-gradient(135deg, #F8F8F0 0%, #F5F5E8 40%, #F7F7DF 70%, #FFFFF8 100%)', // bg-tranquil
                'linear-gradient(135deg, #F0F5F8 0%, #E8F0F5 40%, #DFF2F7 70%, #F8FDFF 100%)'  // bg-gentle
            ];
            
            const selectedBg = dayBackgrounds[bgIndex % dayBackgrounds.length];
            console.log('Setting day background:', selectedBg);
            document.body.style.background = selectedBg;
            bgIndex = (bgIndex + 1) % dayBackgrounds.length;
            console.log('changeBackground complete, new bgIndex =', bgIndex);
        }
        
        function applyNightModeBackground() {
            const nightBackgrounds = [
                'linear-gradient(135deg, #1a1a2e 0%, #16213e 40%, #0f3460 70%, #1a1a2e 100%)',
                'linear-gradient(135deg, #2d1b69 0%, #1a1a2e 40%, #16213e 70%, #0f3460 100%)',
                'linear-gradient(135deg, #232526 0%, #414345 40%, #1a1a2e 70%, #232526 100%)',
                'linear-gradient(135deg, #0c0c0c 0%, #1a1a2e 40%, #16213e 70%, #0f3460 100%)'
            ];
            document.body.style.background = nightBackgrounds[bgIndex % nightBackgrounds.length];
            bgIndex = (bgIndex + 1) % nightBackgrounds.length;
        }
        
        function resetToDefaultBackground() {
            // Reset to default day mode background and fix the index
            document.body.style.background = '';
            backgrounds.forEach(bg => document.body.classList.remove(bg));
            
            // Set the default background and reset index to 0 so changeBackground works properly
            document.body.style.background = 'linear-gradient(135deg, #F5F8FA 0%, #E8F4F8 40%, #DFF3F7 70%, #F0F8FF 100%)';
            
            // Reset bgIndex to 0 so the next changeBackground call works correctly
            bgIndex = 0;
        }
        
        // Auto-advance functionality
        function startAutoAdvance() {
            clearTimeout(autoAdvanceTimer);
            autoAdvanceTimer = setTimeout(() => {
                displayAffirmation();
            }, 120000); // 2 minutes = 120,000 milliseconds
        }
        
        function resetAutoAdvance() {
            startAutoAdvance();
        }
        
        // Load data
        function loadSettings() {
            const saved = localStorage.getItem('serenitySettings');
            if (saved) settings = { ...settings, ...JSON.parse(saved) };
            
            const savedPersonal = localStorage.getItem('serenityPersonalAffirmations');
            if (savedPersonal) personalAffirmations = JSON.parse(savedPersonal);
            
            applySettings();
        }
        
        function saveSettings() {
            localStorage.setItem('serenitySettings', JSON.stringify(settings));
        }
        
        // Apply settings
        function applySettings() {
            document.body.classList.toggle('night-mode', settings.nightMode);
            document.getElementById('nightModeToggle').classList.toggle('active', settings.nightMode);
            updateFilteredAffirmations();
        }
        
        // Favorites
        function getFavorites() {
            const saved = localStorage.getItem('serenityFavorites');
            return saved ? JSON.parse(saved) : [];
        }
        
        function saveFavorites(favorites) {
            localStorage.setItem('serenityFavorites', JSON.stringify(favorites));
        }
        
        function toggleFavorite() {
            if (!currentAffirmation) return;
            const favorites = getFavorites();
            const index = favorites.indexOf(currentAffirmation.text);
            
            if (index === -1) {
                favorites.push(currentAffirmation.text);
            } else {
                favorites.splice(index, 1);
            }
            
            saveFavorites(favorites);
            updateFavoriteButton();
        }
        
        function updateFavoriteButton() {
            if (!currentAffirmation) return;
            const favorites = getFavorites();
            const isFavorited = favorites.includes(currentAffirmation.text);
            const btn = document.getElementById('favoriteBtn');
            btn.textContent = isFavorited ? '♥' : '♡';
            btn.classList.toggle('favorited', isFavorited);
        }
        
        // Categories
        function getCategories() {
            return [...new Set(affirmations.map(a => a.category))].sort();
        }
        
        function updateFilteredAffirmations() {
            let all = [...affirmations, ...personalAffirmations];
            let filtered = all;
            
            if (settings.selectedCategory !== 'all') {
                filtered = filtered.filter(a => a.category === settings.selectedCategory);
            }
            
            if (settings.favoritesOnly) {
                const favorites = getFavorites();
                filtered = filtered.filter(a => favorites.includes(a.text));
            }
            
            filteredAffirmations = filtered.length > 0 ? filtered : all;
        }
        
        function setupCategoryFilter() {
            const container = document.getElementById('categoryFilter');
            const categories = getCategories();
            
            categories.forEach(category => {
                const tag = document.createElement('div');
                tag.className = 'category-tag';
                tag.dataset.category = category;
                tag.textContent = category;
                container.appendChild(tag);
            });
        }
        
        // Settings panel
        function toggleSettings() {
            const panel = document.getElementById('settingsPanel');
            const overlay = document.getElementById('settingsOverlay');
            const isOpen = panel.classList.contains('open');
            panel.classList.toggle('open', !isOpen);
            overlay.classList.toggle('open', !isOpen);
        }
        
        // Reflections
        function openReflectionModal() {
            if (!currentAffirmation) return;
            document.getElementById('reflectionAffirmationText').textContent = currentAffirmation.text;
            document.getElementById('reflectionInputOverlay').classList.add('open');
            document.getElementById('reflectionText').focus();
        }
        
        function closeReflectionInputModal() {
            document.getElementById('reflectionInputOverlay').classList.remove('open');
            document.getElementById('reflectionText').value = '';
        }
        
        function saveReflection() {
            const reflectionText = document.getElementById('reflectionText').value.trim();
            
            if (!reflectionText) {
                closeReflectionInputModal();
                return;
            }
            
            const reflection = {
                affirmation: currentAffirmation.text,
                category: currentAffirmation.category,
                reflection: reflectionText,
                date: new Date().toISOString(),
                isPersonal: currentAffirmation.isPersonal || false
            };
            
            const reflections = getReflections();
            reflections.unshift(reflection);
            
            if (reflections.length > 50) {
                reflections.splice(50);
            }
            
            localStorage.setItem('serenityReflections', JSON.stringify(reflections));
            closeReflectionInputModal();
        }
        
        function getReflections() {
            const saved = localStorage.getItem('serenityReflections');
            return saved ? JSON.parse(saved) : [];
        }
        
        function openReflectionsModal() {
            const reflections = getReflections();
            const listContainer = document.getElementById('reflectionsList');
            
            if (reflections.length === 0) {
                listContainer.innerHTML = '<p style="text-align: center; color: #6B8FA3; padding: 20px;">No reflections yet. Start by clicking the 💭 button!</p>';
            } else {
                listContainer.innerHTML = reflections.map(reflection => {
                    const date = new Date(reflection.date).toLocaleDateString();
                    const personalIndicator = reflection.isPersonal ? ' ✨' : '';
                    return `
                        <div class="reflection-item">
                            <div class="reflection-date">${date}</div>
                            <div class="reflection-affirmation">"${reflection.affirmation.length > 80 ? reflection.affirmation.substring(0, 80) + '...' : reflection.affirmation}"${personalIndicator}</div>
                            <div class="reflection-note">${reflection.reflection}</div>
                        </div>
                    `;
                }).join('');
            }
            
            document.getElementById('reflectionsOverlay').classList.add('open');
        }
        
        function closeReflectionsModal() {
            document.getElementById('reflectionsOverlay').classList.remove('open');
        }
        
        // Personal affirmations
        function openAddPersonalModal() {
            document.getElementById('addPersonalOverlay').classList.add('open');
            document.getElementById('personalText').focus();
        }
        
        function closeAddPersonalModal() {
            document.getElementById('addPersonalOverlay').classList.remove('open');
            document.getElementById('personalText').value = '';
            document.getElementById('personalCategory').value = 'Personal';
        }
        
        function savePersonalAffirmation() {
            const text = document.getElementById('personalText').value.trim();
            const category = document.getElementById('personalCategory').value;
            
            if (!text) {
                alert('Please enter an affirmation text');
                return;
            }
            
            personalAffirmations.push({
                text: text,
                category: category,
                isPersonal: true,
                dateAdded: new Date().toISOString()
            });
            
            localStorage.setItem('serenityPersonalAffirmations', JSON.stringify(personalAffirmations));
            updateFilteredAffirmations();
            setupCategoryFilter();
            closeAddPersonalModal();
        }

        // Core functions
        function getRandomAffirmation() {
            return affirmations[Math.floor(Math.random() * affirmations.length)];
        }

        function getNextWisdom() {
            const wisdom = wisdomQuotes[wisdomIndex];
            wisdomIndex = (wisdomIndex + 1) % wisdomQuotes.length;
            return wisdom;
        }

        function changeBackground() {
            backgrounds.forEach(bg => document.body.classList.remove(bg));
            document.body.classList.add(backgrounds[bgIndex]);
            bgIndex = (bgIndex + 1) % backgrounds.length;
        }

        function displayAffirmation() {
            console.log('displayAffirmation called, settings.nightMode =', settings.nightMode);
            
            const affirmation = getRandomAffirmation();
            currentAffirmation = affirmation;
            const category = document.getElementById('category');
            const content = document.getElementById('content');
            
            // Fade out
            content.classList.add('updating');
            
            // Change background based on mode (original logic)
            if (settings.nightMode) {
                console.log('displayAffirmation: calling applyNightModeBackground');
                applyNightModeBackground();
            } else {
                console.log('displayAffirmation: calling changeBackground, bgIndex =', bgIndex);
                
                // Call changeBackground inline to test
                const dayBackgrounds = [
                    'linear-gradient(135deg, #F0F8F0 0%, #E8F5E8 40%, #DFF7DF 70%, #F8FFF8 100%)', // bg-peaceful
                    'linear-gradient(135deg, #F8F5F8 0%, #F0E8F0 40%, #F2DFF2 70%, #FFF8FF 100%)', // bg-calm  
                    'linear-gradient(135deg, #F8F8F0 0%, #F5F5E8 40%, #F7F7DF 70%, #FFFFF8 100%)', // bg-tranquil
                    'linear-gradient(135deg, #F0F5F8 0%, #E8F0F5 40%, #DFF2F7 70%, #F8FDFF 100%)'  // bg-gentle
                ];
                
                const selectedBg = dayBackgrounds[bgIndex % dayBackgrounds.length];
                console.log('displayAffirmation: setting day background:', selectedBg);
                document.body.style.background = selectedBg;
                bgIndex = (bgIndex + 1) % dayBackgrounds.length;
                console.log('displayAffirmation: background change complete, new bgIndex =', bgIndex);
            }
            
            setTimeout(() => {
                category.textContent = affirmation.category;
                content.textContent = affirmation.text;
                updateFavoriteButton();
                
                // Fade in
                content.classList.remove('updating');
                
                // Reset auto-advance timer
                resetAutoAdvance();
            }, 300);
        }

        function showWisdom() {
            const wisdom = getNextWisdom();
            const wisdomContent = document.getElementById('wisdomContent');
            wisdomContent.textContent = wisdom;
            wisdomContent.style.display = 'block';
            
            setTimeout(() => {
                wisdomContent.style.display = 'none';
            }, 15000);
        }

        // Touch handling
        let touchStartY = 0;
        let isScrolling = false;
        
        function handleTouch() {
            const contentArea = document.getElementById('contentArea');
            
            contentArea.addEventListener('touchstart', (e) => {
                if (e.target.closest('.favorite-btn') || e.target.closest('.reflect-btn')) {
                    return;
                }
                touchStartY = e.touches[0].clientY;
                isScrolling = false;
            }, { passive: true });
            
            contentArea.addEventListener('touchmove', (e) => {
                const diff = Math.abs(touchStartY - e.touches[0].clientY);
                if (diff > 10) isScrolling = true;
            }, { passive: true });
            
            contentArea.addEventListener('touchend', (e) => {
                if (e.target.closest('.favorite-btn') || e.target.closest('.reflect-btn')) {
                    return;
                }
                if (isScrolling) return;
                displayAffirmation();
            }, { passive: true });

            contentArea.addEventListener('click', (e) => {
                if (e.target.closest('.favorite-btn') || e.target.closest('.reflect-btn')) {
                    return;
                }
                if (!isScrolling) displayAffirmation();
            });
        }

        // Event listeners
        function setupEventListeners() {
            // Settings
            document.getElementById('settingsBtn').addEventListener('click', toggleSettings);
            document.getElementById('settingsOverlay').addEventListener('click', toggleSettings);
            
            // Next button
            document.getElementById('nextBtn').addEventListener('click', displayAffirmation);
            
            // Main buttons
            document.getElementById('favoriteBtn').addEventListener('click', toggleFavorite);
            document.getElementById('reflectBtn').addEventListener('click', openReflectionModal);
            
            // Settings toggles
            document.getElementById('nightModeToggle').addEventListener('click', () => {
                console.log('Night mode toggle clicked! Current state:', settings.nightMode);
                settings.nightMode = !settings.nightMode;
                console.log('New night mode state:', settings.nightMode);
                saveSettings();
                
                // Call applySettings directly inline to test
                console.log('About to call applySettings directly...');
                try {
                    const wasNightMode = document.body.classList.contains('night-mode');
                    console.log('Direct call: wasNightMode =', wasNightMode, 'settings.nightMode =', settings.nightMode);
                    
                    document.body.classList.toggle('night-mode', settings.nightMode);
                    document.getElementById('nightModeToggle').classList.toggle('active', settings.nightMode);
                    
                    console.log('After direct toggle: body has night-mode class =', document.body.classList.contains('night-mode'));
                    
                    // Handle background change
                    if (wasNightMode !== settings.nightMode) {
                        console.log('DIRECT MODE CHANGE DETECTED!');
                        if (settings.nightMode) {
                            console.log('Direct call: applyNightModeBackground');
                            applyNightModeBackground();
                        } else {
                            console.log('Direct call: resetToDefaultBackground');
                            resetToDefaultBackground();
                            console.log('resetToDefaultBackground complete, bgIndex now =', bgIndex);
                            // Force an immediate background change to test
                            setTimeout(() => {
                                console.log('Forcing immediate changeBackground after mode switch');
                                changeBackground();
                                console.log('Forced changeBackground complete, bgIndex now =', bgIndex);
                            }, 100);
                        }
                    }
                } catch (error) {
                    console.error('ERROR in direct call:', error);
                }
                
                console.log('Direct call complete');
            });
            
            // Personal affirmations
            document.getElementById('addPersonalBtn').addEventListener('click', openAddPersonalModal);
            document.getElementById('savePersonalBtn').addEventListener('click', savePersonalAffirmation);
            document.getElementById('cancelPersonalBtn').addEventListener('click', closeAddPersonalModal);
            document.getElementById('addPersonalOverlay').addEventListener('click', (e) => {
                if (e.target === e.currentTarget) closeAddPersonalModal();
            });
            
            // Reflections
            document.getElementById('viewReflectionsBtn').addEventListener('click', openReflectionsModal);
            document.getElementById('closeReflectionsBtn').addEventListener('click', closeReflectionsModal);
            document.getElementById('reflectionsOverlay').addEventListener('click', (e) => {
                if (e.target === e.currentTarget) closeReflectionsModal();
            });
            
            document.getElementById('saveReflectionBtn').addEventListener('click', saveReflection);
            document.getElementById('skipReflectionBtn').addEventListener('click', closeReflectionInputModal);
            document.getElementById('reflectionInputOverlay').addEventListener('click', (e) => {
                if (e.target === e.currentTarget) closeReflectionInputModal();
            });
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            loadSettings();
            setupCategoryFilter();
            displayAffirmation();
            handleTouch();
            setupEventListeners();
            
            // Start auto-advance timer
            startAutoAdvance();
            
            // Show wisdom periodically
            setInterval(showWisdom, 30000); // Every 30 seconds for demo
        });

        // Prevent context menu
        document.addEventListener('contextmenu', (e) => e.preventDefault());
    </script>
</body>
</html>